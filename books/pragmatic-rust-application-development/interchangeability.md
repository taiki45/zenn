---
title: "äº¤æ›å¯èƒ½æ€§"
---

å®Ÿä¸–ç•Œã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ã‚‹æ™‚ã«ã€ãƒ†ã‚¹ãƒˆã‚„ç•°ãªã‚‹ã‚·ãƒŠãƒªã‚ªã§å‹•ä½œã‚’å¤‰ãˆã‚‹ãŸã‚ã«äº¤æ›å¯èƒ½æ€§ãŒå¿…è¦ã¨ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ã©ã®é–¢æ•°ãŒå‘¼ã°ã‚Œã‚‹ã‹ã‚ã‹ã‚‹ã‚ˆã†ãªé™çš„ãªäº¤æ›å¯èƒ½æ€§ã«ã¯é™çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãŒã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ã©ã®é–¢æ•°å‘¼ã°ã‚Œã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã‚ˆã†ãªå‹•çš„ãªäº¤æ›å¯èƒ½æ€§ã«ã¯å‹•çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãŒãã‚Œãã‚Œåˆ©ç”¨ã§ãã¾ã™ã€‚

## é™çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒ
æ¸¡ã•ã‚Œã‚‹å‹æ¯ã«å®Ÿè£…ã‚’ç”Ÿæˆã™ã‚‹ã®ã§ã€å®Ÿè¡Œæ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒãªã(ã‚‚ã—ãã¯å°‘ãªã)ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®æœ€é©åŒ–ã®ä½™åœ°ã‚‚ã‚ã‚Šã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çš„ã«æœ‰åˆ©ã§ã™ã€‚ä»£ã‚ã‚Šã«ç”Ÿæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒå¢—ãˆã‚‹ã®ã§ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚é–“ã¯(å°‘ã—)å¢—åŠ ã—ã¾ã™ã€‚

ãƒ†ã‚¹ãƒˆç”¨ã®å®Ÿè£…ç½®ãæ›ãˆã‚„ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã§ã‚·ãƒŠãƒªã‚ªãŒæ±ºã¾ã£ã¦ã„ã‚‹ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã¯ã€é™çš„ã«ãƒ¡ã‚½ãƒƒãƒ‰ãŒè§£æ±ºå¯èƒ½ãªã®ã§é™çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã§ååˆ†ã§ã™ã€‚

ä¾‹ãˆã°ã€GitHubã®webhookã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹ã‚ˆã†ãªãƒãƒ³ãƒ‰ãƒ©ãƒ¼æ›¸ãã¨ã—ã¾ã™ã€‚ã•ã‚‰ã«ã€å‡¦ç†ã®æœ€ä¸­ã«GitHub APIã¨ã‚„ã‚Šã¨ã‚Šã—ãŸã„ã®ã§GitHubã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆ©ç”¨ã—ãŸã„ã¨ã—ã¾ã™ã€‚ã“ã®æ™‚ã«å‡¦ç†é–¢æ•°ã®ä¸­ã§æ¯å›ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã®ã§ã¯ãªãã€ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’æ§‹é€ ä½“ã«ã—ã¦ãã®æ§‹é€ ä½“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æŒãŸã›ã‚‹ã¨ã—ã¾ã™ã€‚ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆæ™‚ã¯ãƒ¢ãƒƒã‚¯ã«ç½®ãæ›ãˆãŸã„æ™‚ã®ä¾‹ã§ã™:

ã¾ãštraitã‚’å®šç¾©ã—ã¾ã™ã€‚asyncé–¢ä¿‚ã¯å¾Œã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã§ç´¹ä»‹ã—ã¾ã™ã€‚

```rust
#[allow(clippy::indexing_slicing)] // For automock.
#[cfg_attr(test, mockall::automock)]
#[async_trait]
pub trait GithubClient: Send + Sync {
    async fn create_check_run(
        &self,
        owner: &str,
        repo: &str,
        input: &ChecksCreateRequest,
    ) -> Result<CheckRun>;

    async fn update_check_run(
        &self,
        owner: &str,
        repo: &str,
        check_run_id: i64,
        input: &ChecksUpdateRequest,
    ) -> Result<CheckRun>;
}
```

å®Ÿéš›ã«GitHub APIã¨é€šä¿¡ã™ã‚‹å…·ä½“çš„ãªå‹ã‚’å®šç¾©ã—ã¾ã™ã€‚ä½™è«‡ã§ã™ãŒã€octorust crateã‚’æ–°è¦ã«åˆ©ç”¨ã™ã‚‹ã®ã¯ãŠã™ã™ã‚ã—ãªã„ã§ã™ğŸ˜‡

```rust
pub struct OctorustClient {
    checks: Checks,
    repos: Repos,
    http: ClientWithMiddleware,
}

impl OctorustClient {
    // Traitã«é–¢ä¿‚ãªã„associated functionã¨ã‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚è‡ªç”±ã«å®šç¾©ã—ã¦ä½¿ãˆã¾ã™ã€‚
    pub fn new(config: GithubApiConfig, app: GithubAppConfig) -> Result<Self> {
        // ...
    }
}

#[async_trait]
impl GithubClient for OctorustClient {
    async fn create_check_run(
        &self,
        owner: &str,
        repo: &str,
        input: &ChecksCreateRequest,
    ) -> Result<CheckRun> {
        // ...
    }

    async fn update_check_run(
        &self,
        owner: &str,
        repo: &str,
        check_run_id: i64,
        input: &ChecksUpdateRequest,
    ) -> Result<CheckRun> {
        // ...
    }
}
```

ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«æŒãŸã›ã¾ã™ã€‚`GitHubClient` ã¯traitã§ `CL` ã¯type parameterã§ã™ã€‚

```rust
pub struct Handler<CL: GithubClient, CH: Checkout, F: TokenFetcher> {
    config: Config,
    runner_job_name: String,
    client: CL,
    checkout: CH,
    token_fetcher: F,
}
```

å®Ÿéš›ã«GitHubã®webhookã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ãªã©ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã§ã€ãƒãƒ³ãƒ‰ãƒ©ãƒ¼æ§‹é€ ä½“ã‚’åˆæœŸåŒ–ã—ã¦å‡¦ç†ã‚’ã•ã›ã¾ã™ã€‚

```rust
let client = OctorustClient::new(args.github_config.clone(), args.github_app_config.clone())?;
// ...
let handler = Handler::new(args.handler_config, client, checkout, fetcher);

let service = service_fn(|event: LambdaEvent<EventBridgeEvent<CheckRequest>>| {
    let h = &handler;
    async move {
        let res = h.handle_event(&event.payload.detail).await;
        if let Err(e) = res.as_ref() {
            error!("handling event failed: {}", e);
        }
        res
    }
});
```

ãƒ†ã‚¹ãƒˆæ™‚ã¯GitHubã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…ã¯ãƒ¢ãƒƒã‚¯ã«åˆ‡ã‚Šæ›¿ãˆãŸã„ã§ã™ã€‚`GithubClient` traitã‚’å®Ÿè£…ã—ãŸå…·ä½“çš„ãªå‹ã§ã‚ã‚‹ã€ãƒ¢ãƒƒã‚¯æ§‹é€ ä½“ã‚’ç”¨æ„ã—ã¾ã™ã€‚ã“ã“ã§ã¯[mockall](https://docs.rs/mockall/latest/mockall/)ã¨ã„ã†crateã‚’ä½¿ã£ã¦è‡ªå‹•ã§ãƒ¢ãƒƒã‚¯æ§‹é€ ä½“ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚

```rust
// å†æ²
#[allow(clippy::indexing_slicing)] // For automock.
#[cfg_attr(test, mockall::automock)]
#[async_trait]
pub trait GithubClient: Send + Sync {
    async fn create_check_run(
        &self,
        owner: &str,
        repo: &str,
        input: &ChecksCreateRequest,
    ) -> Result<CheckRun>;

    async fn update_check_run(
        &self,
        owner: &str,
        repo: &str,
        check_run_id: i64,
        input: &ChecksUpdateRequest,
    ) -> Result<CheckRun>;
}
```

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã§ãƒãƒ³ãƒ‰ãƒ©ãƒ¼æ§‹é€ ä½“ã‚’åˆæœŸåŒ–ã™ã‚‹æ™‚ã«ã€ãƒ¢ãƒƒã‚¯æ§‹é€ ä½“ã‚’ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«æ¸¡ã—ã¾ã™ã€‚ã“ã†ã—ã¦ãƒ†ã‚¹ãƒˆæ™‚ã¯ãƒ¢ãƒƒã‚¯ã«äº¤æ›ã§ãã¾ã™ã€‚

```rust
#[tokio::test]
async fn ok() {
    // ...

    let mut client = MockGithubClient::new();

    // ...

    let handler = Handler::new(config, client, checkout, fetcher);

    let mut req = build_checkrequest();
    // ...
    let res = handler.handle_event(&req).await;
    // ...
}
```

æœ€åˆã¯æ…£ã‚Œãªã„ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ãŒã€ã“ã®ä¾‹ã§è¨€ã† `OctorustClient` ã¨ `MockGithubClient` ã®ãã‚Œãã‚Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¯¾å¿œã™ã‚‹é–¢æ•°ã‚„æ§‹é€ ä½“ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒåˆ¥ã€…ã«ç”Ÿæˆã—ã¦ã„ã‚‹ã‚“ã ãªã€ã¨ã„ã†ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ã§OKã§ã™ã€‚

## å‹•çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒ
ä¾‹ãˆã°ã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å…ƒã«æ–‡å­—åˆ—ã‚’å‡ºåŠ›ã™ã‚‹å…ˆã‚’æ±ºã‚ã‚‹ã€ã‚ˆã†ãªäº¤æ›å¯èƒ½æ€§ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã¯å‹•çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã‚’åˆ©ç”¨ã—ã¾ã™ã€‚Rustã§ã¯traitã‚’trait objectsã¨ã—ã¦åˆ©ç”¨ã™ã‚‹ã“ã¨ã§å‹•çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã‚’å®Ÿç¾ã§ãã¾ã™ã€‚Trait objectsã¯ãƒã‚¤ãƒ³ã‚¿å‹ã¨ `dyn` ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦æ›¸ãã¾ã™ã€‚ä¾‹ã¨ã—ã¦ã‚ˆã `Box` å‹ãŒä½¿ã‚ã‚Œã¾ã™ãŒã€å‚ç…§ã§ã‚‚ä»–ã®ã‚¹ãƒãƒ¼ãƒˆãƒã‚¤ãƒ³ã‚¿å‹ (`Arc` ãªã©) ã§ã‚‚å¯èƒ½ã§ã™ã€‚

ä¾‹ã®ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å…ƒã«æ–‡å­—åˆ—ã‚’å‡ºåŠ›ã™ã‚‹å…ˆã‚’æ±ºã‚ã‚‹ã€ã‚±ãƒ¼ã‚¹ã§ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```rust
let mut out: Box<dyn Write> = match args.output {
    Some(path) => Box::new(File::create(path)?),
    None => Box::new(stdout()),
};
write!(&mut out, "{}", toml::to_string(&config)?)?;
```

å‹•çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã¯ä»–ã®è¨€èªã§ã‚‚ã‚ˆãã‚ã‚‹ã®ã§ç‰¹ã«æˆ¸æƒ‘ã†ã“ã¨ãªãåˆ©ç”¨ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

ä¸€ç‚¹ã€Rustã«ã¯ `Deref` traitã¨ã„ã†ä»•çµ„ã¿ãŒã‚ã‚Šã€`Box` ã®ã‚ˆã†ãªã‚¹ãƒãƒ¼ãƒˆãƒã‚¤ãƒ³ã‚¿ã‚‚é€šå¸¸ã®å‚ç…§ã®ã‚ˆã†ã«dereference operator (`*`)ã‚’ä½¿ã‚ãšã«å†…éƒ¨ã®å‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚`Box` ã‚„ `Arc` å‹ãªã®ã«ã€å†…éƒ¨ã®å‹ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã®ã¯ã“ã®ä»•çµ„ã¿ã®ãŠã‹ã’ã§ã™ã€‚ãƒŠã‚¤ã‚¹æŠ½è±¡ï¼

## é–¢é€£è³‡æ–™
- https://doc.rust-lang.org/book/ch17-02-trait-objects.html
- https://doc.rust-lang.org/book/ch19-04-advanced-types.html#dynamically-sized-types-and-the-sized-trait
- https://doc.rust-lang.org/book/ch15-02-deref.html#treating-smart-pointers-like-regular-references-with-the-deref-trait
